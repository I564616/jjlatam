<?xml version="1.0" encoding="UTF-8"?>
<!--
 [y] hybris Platform

 Copyright (c) 2018 SAP SE
 All rights reserved.
-->
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:security="http://www.springframework.org/schema/security"
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/security
        http://www.springframework.org/schema/security/spring-security.xsd">

    <!-- Swagger resources -->
    <security:http pattern="/#{configurationService.configuration.getProperty('springfox.documentation.swagger.v2.path')}"
                   security="none"/>

    <security:http pattern="/*swagger*/**"
                   security="none"/>

    <!-- Commerce Webservices V2 â€“ New OAuth2 / JWT Based -->
    <security:http pattern="/v2/**"
                   use-authorization-manager="true"
                   use-expressions="true"
                   create-session="stateless">

        <security:anonymous username="anonymous" granted-authority="ROLE_ANONYMOUS"/>

        <!-- Enforce HTTPS -->
        <security:intercept-url pattern="/**" requires-channel="https" access="permitAll"/>

        <!-- Port mappings -->
        <security:port-mappings>
            <security:port-mapping
                    http="#{configurationService.configuration.getProperty('tomcat.http.port')}"
                    https="#{configurationService.configuration.getProperty('tomcat.ssl.port')}"/>
            <security:port-mapping
                    http="#{configurationService.configuration.getProperty('embeddedserver.http.port')}"
                    https="#{configurationService.configuration.getProperty('embeddedserver.ssl.port')}"/>
        </security:port-mappings>

        <!-- Replace old resourceServerFilter -->
        <security:custom-filter ref="jwtAuthenticationUserFilter" after="LAST" />

        <!-- Updated Headers -->
        <security:headers>
            <security:content-type-options />
            <security:hsts include-subdomains="true" max-age-seconds="16070400" />
            <security:xss-protection />
            <security:frame-options disabled="true"/>
        </security:headers>

        <security:csrf disabled="true"/>

        <!-- NEW OAuth2 Resource Server with JWT -->
        <security:oauth2-resource-server entry-point-ref="enrichingAuthenticationEntryPoint">
            <security:jwt decoder-ref="jwtDecoder"
                          jwt-authentication-converter-ref="jwtAuthenticationRoleConverter" />
        </security:oauth2-resource-server>

        <security:access-denied-handler ref="enrichingAccessDeniedHandler" />

    </security:http>

</beans>

