<!--<?xml version="1.0" encoding="UTF-8"?>-->
<!--&lt;!&ndash;-->
<!-- [y] hybris Platform-->

<!-- Copyright (c) 2018 SAP SE or an SAP affiliate company.  All rights reserved.-->

<!-- This software is the confidential and proprietary information of SAP-->
<!-- ("Confidential Information"). You shall not disclose such Confidential-->
<!-- Information and shall use it only in accordance with the terms of the-->
<!-- license agreement you entered into with SAP.-->
<!--&ndash;&gt;-->
<!--<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"-->
<!--	xmlns:security="http://www.springframework.org/schema/security"-->
<!--	xsi:schemaLocation="http://www.springframework.org/schema/beans-->
<!--		http://www.springframework.org/schema/beans/spring-beans.xsd-->
<!--		http://www.springframework.org/schema/security -->
<!--		http://www.springframework.org/schema/security/spring-security.xsd">-->

<!--	&lt;!&ndash; Swagger resources &ndash;&gt;-->
<!--	<security:http pattern="/v1/#{configurationService.configuration.getProperty('springfox.documentation.swagger.v2.path')}" security="none"/>-->
<!--	<security:http pattern="/v1/*swagger*/**" security="none"/>-->

<!--	&lt;!&ndash; Commerce Webservices V1&ndash;&gt;-->
<!--	<http pattern="/v1/**" entry-point-ref="oauthAuthenticationEntryPointV1" access-decision-manager-ref="webSecurityAccessDecisionManager"-->
<!--		xmlns="http://www.springframework.org/schema/security" use-expressions="false">-->

<!--		<anonymous username="anonymous" granted-authority="ROLE_ANONYMOUS" />-->
<!--		<session-management session-authentication-strategy-ref="fixation" />-->

<!--		<intercept-url pattern="/**/cart/promotion/**" access="CLIENT_TRUSTED_CLIENT" requires-channel="https" />-->
<!--		<intercept-url pattern="/**" requires-channel="https"/>-->
<!--		-->
<!--		<port-mappings>-->
<!--			<port-mapping http="#{configurationService.configuration.getProperty('tomcat.http.port')}" -->
<!--						  https="#{configurationService.configuration.getProperty('tomcat.ssl.port')}" />-->
<!--			<port-mapping http="#{configurationService.configuration.getProperty('embeddedserver.http.port')}" -->
<!--						  https="#{configurationService.configuration.getProperty('embeddedserver.ssl.port')}" />			-->
<!--		</port-mappings>-->

<!--		<custom-filter ref="resourceServerFilter" before="PRE_AUTH_FILTER" />-->
<!--		<custom-filter ref="hybrisUserFilter" after="LAST" />-->
<!--		<access-denied-handler ref="oauthAccessDeniedHandlerV1" />-->
<!--		-->
<!--		<headers>-->
<!--			<content-type-options />-->
<!--			<hsts include-subdomains="true" max-age-seconds="16070400" />-->
<!--			<xss-protection />-->
<!--			<security:frame-options disabled="true"/>-->
<!--		</headers>	-->
<!--		<security:csrf disabled="true"/>	-->
<!--	</http>-->

<!--	<bean id="oauthAuthenticationEntryPointV1" parent="oauthAuthenticationEntryPoint">-->
<!--		<property name="exceptionRenderer" ref="oAuth2ExceptionRendererV1" />-->
<!--	</bean>-->

<!--	<bean id="oauthAccessDeniedHandlerV1" parent="oauthAccessDeniedHandler">-->
<!--		<property name="exceptionRenderer" ref="oAuth2ExceptionRendererV1" />-->
<!--	</bean>-->

<!--	<bean id="oAuth2ExceptionRendererV1" parent="oAuth2ExceptionRenderer">-->
<!--		<property name="messageConverters" ref="messageConvertersV1" />-->
<!--	</bean>-->
<!--</beans>-->
<?xml version="1.0" encoding="UTF-8"?>
<!--
 [y] hybris Platform
-->
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:security="http://www.springframework.org/schema/security"
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/security
        http://www.springframework.org/schema/security/spring-security.xsd">

    <!-- Swagger resources -->
    <security:http pattern="/v1/#{configurationService.configuration.getProperty('springfox.documentation.swagger.v2.path')}"
                   security="none"/>
    <security:http pattern="/v1/*swagger*/**" security="none"/>

    <!-- Commerce Webservices V1 â€“ Updated to new OAuth2/JWT Security -->
    <security:http pattern="/v1/**"
                   use-authorization-manager="true"
                   use-expressions="true"
                   create-session="stateless">

        <security:anonymous username="anonymous" granted-authority="ROLE_ANONYMOUS"/>

        <!-- Session management support retained for V1 -->
        <security:session-management session-authentication-strategy-ref="fixation" />

        <!-- Your original special access rule -->
        <security:intercept-url pattern="/**/cart/promotion/**"
                                requires-channel="https"
                                access="hasAuthority('CLIENT_TRUSTED_CLIENT')"/>

        <security:intercept-url pattern="/**"
                                requires-channel="https"
                                access="permitAll"/>

        <!-- Port mappings -->
        <security:port-mappings>
            <security:port-mapping
                    http="#{configurationService.configuration.getProperty('tomcat.http.port')}"
                    https="#{configurationService.configuration.getProperty('tomcat.ssl.port')}"/>
            <security:port-mapping
                    http="#{configurationService.configuration.getProperty('embeddedserver.http.port')}"
                    https="#{configurationService.configuration.getProperty('embeddedserver.ssl.port')}"/>
        </security:port-mappings>

        <!-- Replace resourceServerFilter with JWT authentication processing -->
        <security:custom-filter ref="jwtAuthenticationUserFilter" after="LAST" />
        <security:custom-filter ref="hybrisUserFilter" after="LAST" />

        <!-- Updated handlers -->
        <security:access-denied-handler ref="enrichingAccessDeniedHandler" />

        <!-- Updated headers -->
        <security:headers>
            <security:content-type-options/>
            <security:hsts include-subdomains="true" max-age-seconds="16070400"/>
            <security:xss-protection/>
            <security:frame-options disabled="true"/>
        </security:headers>

        <security:csrf disabled="true"/>

        <!-- NEW OAuth2 Resource Server (JWT based) -->
        <security:oauth2-resource-server entry-point-ref="enrichingAuthenticationEntryPoint">
            <security:jwt decoder-ref="jwtDecoder"
                          jwt-authentication-converter-ref="jwtAuthenticationRoleConverter"/>
        </security:oauth2-resource-server>

    </security:http>

</beans>
