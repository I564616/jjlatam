<?xml version="1.0" encoding="UTF-8"?>
<!--
 [y] hybris Platform
-->
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:security="http://www.springframework.org/schema/security"
       xsi:schemaLocation="
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/security
        http://www.springframework.org/schema/security/spring-security.xsd">

    <!-- Swagger resources -->
    <security:http pattern="/v1/#{configurationService.configuration.getProperty('springfox.documentation.swagger.v2.path')}"
                   security="none"/>
    <security:http pattern="/v1/*swagger*/**" security="none"/>

    <!-- Commerce Webservices V1 â€“ Updated to new OAuth2/JWT Security -->
    <security:http pattern="/v1/**"
                   use-authorization-manager="false"
                   use-expressions="true"
                   create-session="stateless">

        <security:anonymous username="anonymous" granted-authority="ROLE_ANONYMOUS"/>

        <!-- Session management support retained for V1 -->
        <security:session-management session-authentication-strategy-ref="fixation" />

        <!-- Your original special access rule -->
        <security:intercept-url pattern="/**/cart/promotion/**"
                                requires-channel="https"
                                access="hasAuthority('CLIENT_TRUSTED_CLIENT')"/>

        <security:intercept-url pattern="/**"
                                requires-channel="https"
                                access="permitAll()"/>

        <!-- Port mappings -->
        <security:port-mappings>
            <security:port-mapping
                    http="#{configurationService.configuration.getProperty('tomcat.http.port')}"
                    https="#{configurationService.configuration.getProperty('tomcat.ssl.port')}"/>
            <security:port-mapping
                    http="#{configurationService.configuration.getProperty('embeddedserver.http.port')}"
                    https="#{configurationService.configuration.getProperty('embeddedserver.ssl.port')}"/>
        </security:port-mappings>

        <!-- Replace resourceServerFilter with JWT authentication processing -->
        <security:custom-filter ref="jwtAuthenticationUserFilter" after="LAST" />
        <security:custom-filter ref="hybrisUserFilter" after="LAST" />

        <!-- Updated handlers -->
        <security:access-denied-handler ref="enrichingAccessDeniedHandler" />

        <!-- Updated headers -->
        <security:headers>
            <security:content-type-options/>
            <security:hsts include-subdomains="true" max-age-seconds="16070400"/>
            <security:xss-protection/>
            <security:frame-options disabled="true"/>
        </security:headers>

        <security:csrf disabled="true"/>

        <!-- NEW OAuth2 Resource Server (JWT based) -->
        <security:oauth2-resource-server entry-point-ref="enrichingAuthenticationEntryPoint">
            <security:jwt decoder-ref="jwtDecoder"
                          jwt-authentication-converter-ref="jwtAuthenticationRoleConverter"/>
        </security:oauth2-resource-server>

    </security:http>

</beans>
